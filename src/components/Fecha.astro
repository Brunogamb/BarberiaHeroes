---
let fecha = "";
let hora = "";
---

<section id="fecha" class="fecha-section" style="display: none;">
	<div class="container">
        <button class="back-btn2">Volver</button>
		<div class="form-grid">
			<h2>ELEGÍ LA FECHA Y HORARIO</h2>

			<div class="calendar-card">
				<div class="cal-header">
					<button id="prevMonth" class="cal-nav" aria-label="Mes anterior">&lt;</button>
					<div class="cal-title" id="calTitle">Noviembre 2025</div>
					<button id="nextMonth" class="cal-nav" aria-label="Mes siguiente">&gt;</button>
				</div>

				<div class="cal-weekdays">
					<div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sá</div>
				</div>

				<div id="calendarGrid" class="cal-grid"></div>
			</div>

			<form id="form-fecha" class="fecha-form">

				<input type="hidden" id="fecha" name="fecha" required>

				<div class="input-group">
					<label for="hora">Horario</label>
					<input
						type="time"
						id="hora"
						name="hora"
						required
					/>
				</div>

				<button type="submit" class="btn-confirmar">Confirmar</button>
			</form>

			<div id="resumen-turno" class="resumen-turno hidden">
				<h3>Turno seleccionado</h3>
				<p><strong>Fecha:</strong> <span id="fecha-seleccionada"></span></p>
				<p><strong>Horario:</strong> <span id="hora-seleccionada"></span></p>
			</div>
		</div>
	</div>
</section>

<style is:global>
    .fecha-section {
        background: var(--color-bg);
        padding: 40px 0;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
        position: relative; 
    }

    .back-btn2 {
        font-size: 0.9rem;
        background-color: var(--color-accent);
        color: var(--color-white);
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        position: absolute;
        left: -80px;
        top: 24px;
    }

    .form-grid {
        background: var(--color-white);
        border-radius: 1rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        padding: 24px;
    }

    h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 16px;
    }

    .calendar-card {
        width: 100%;
        margin: 0 auto 1.5rem;
        border: 1px solid var(--color-text-light);
        border-radius: 1rem;
        overflow: hidden;
        background: var(--color-white);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    .cal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--color-text-light);
        color: var(--color-white);
    }

    .cal-title {
        font-weight: 600;
        font-size: 1.2rem;
    }

    .cal-nav {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: var(--color-white);
        padding: 6px 12px;
        font-size: 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .cal-nav:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .cal-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: #fafafa;
        padding: 8px 0;
        font-weight: 600;
        color: var(--color-text);
        font-size: 1.1rem;
        border-bottom: 1px solid var(--color-white);
    }

    .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        padding: 12px;
    }

    .cal-cell {
        height: 60px;
        border-radius: 8px;
        background: var(--color-white);
        border: 1px solid var(--color-text-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .cal-cell.empty {
        background: transparent;
        border: none;
        cursor: default;
    }

    .cal-cell.day:hover:not(.disabled):not(.selected) {
        background: var(--color-text-light);
        color: var(--color-white);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .cal-cell.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: var(--color-white);
    }

    .cal-cell.selected {
        background: var(--color-text-light);
        color: var(--color-white);
        transform: scale(1.03);
    }

    .fecha-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 2rem;
        align-items: center;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 400px;
        text-align: left;
    }

    .input-group label {
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--color-text);
    }

    .input-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--color-text-light);
        border-radius: 0.75rem;
        font-size: 1rem;
        outline: none;
        transition: all 0.2s ease;
    }

    .btn-confirmar {
        margin-top: 1rem;
        padding: 0.9rem 2rem;
        background: var(--color-accent);
        color: var(--color-white);
        border: none;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-confirmar:hover {
        background: var(--color-text-light);
    }

    .resumen-turno {
        margin-top: 2rem;
        padding: 1.5rem;
        border: 1px solid #ddd;
        border-radius: 1rem;
        background: var(--color-white);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        text-align: left;
        line-height: 1.6;
    }

    .resumen-turno h3 {
        margin-bottom: 0.5rem;
        color: var(--color-accent);
    }

    .hidden {
        display: none;
    }
</style>


<script type="module">
	document.addEventListener('DOMContentLoaded', () => {

		const calendarGrid = document.getElementById('calendarGrid');
		const calTitle = document.getElementById('calTitle');
		const prevBtn = document.getElementById('prevMonth');
		const nextBtn = document.getElementById('nextMonth');
		const hiddenFecha = document.getElementById('fecha'); 
		const form = document.getElementById('form-fecha');
		const resumen = document.getElementById('resumen-turno');
		const fechaSpan = document.getElementById('fecha-seleccionada');
		const horaSpan = document.getElementById('hora-seleccionada');

		const today = new Date();
		let viewDate = new Date(today.getFullYear(), today.getMonth(), 1); 
		let selectedDate = null; 

		const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

		function pad(n){ return n < 10 ? '0'+n : n; }
		function formatISO(d){
			return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
		}
		function formatReadable(d){

			const dayNames = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
			return `${dayNames[d.getDay()]}, ${pad(d.getDate())} de ${monthNames[d.getMonth()]} de ${d.getFullYear()}`;
		}

		function renderCalendar(){

			calTitle.textContent = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;

			calendarGrid.innerHTML = '';

			const firstDayIndex = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();

			const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();

			for(let i=0; i<firstDayIndex; i++){
				const empty = document.createElement('div');
				empty.className = 'cal-cell empty';
				calendarGrid.appendChild(empty);
			}

			for(let day=1; day<=daysInMonth; day++){
				const cell = document.createElement('button');
				cell.type = 'button';
				cell.className = 'cal-cell day';
				cell.textContent = day;

				const cellDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);

				const todayNoTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());
				if(cellDate < todayNoTime){
					cell.classList.add('disabled');
					cell.disabled = true;
				}

				if(selectedDate &&
					selectedDate.getFullYear() === cellDate.getFullYear() &&
					selectedDate.getMonth() === cellDate.getMonth() &&
					selectedDate.getDate() === cellDate.getDate()){
					cell.classList.add('selected');
				}

				cell.addEventListener('click', () => {

					const prev = calendarGrid.querySelector('.cal-cell.selected');
					if(prev) prev.classList.remove('selected');

					cell.classList.add('selected');
					selectedDate = cellDate;

					hiddenFecha.value = formatISO(selectedDate);

					fechaSpan.textContent = formatReadable(selectedDate);
				});

				calendarGrid.appendChild(cell);
			}

		}

		prevBtn.addEventListener('click', () => {
			viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1);
			renderCalendar();
		});
		nextBtn.addEventListener('click', () => {
			viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1);
			renderCalendar();
		});

		renderCalendar();

		form.addEventListener('submit', (e) => {
			e.preventDefault();
			const hora = form.hora.value;

			if(!selectedDate){
				alert('Por favor seleccioná una fecha en el calendario.');
				return;
			}
			if(!hora){
				alert('Por favor seleccioná un horario.');
				return;
			}

			fechaSpan.textContent = formatReadable(selectedDate);
			horaSpan.textContent = hora;
			resumen.classList.remove('hidden');
			resumen.scrollIntoView({ behavior: 'smooth' });
		});
	});
</script>